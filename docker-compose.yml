services:
  postgres:
    image: postgres:16-alpine
    container_name: dropship_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me}
      POSTGRES_DB: ${POSTGRES_DB:-dropship_bot}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: dropship_queue
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  migrate:
    build: .
    container_name: dropship_migrate
    restart: "no"
    depends_on:
      - postgres
      - redis
    env_file:
      - secrets.env
    environment:
      # Override local values from secrets.env when running in Docker.
      DATABASE_URL: postgresql://admin:${POSTGRES_PASSWORD:-change_me}@postgres:5432/${POSTGRES_DB:-dropship_bot}?schema=public
      REDIS_URL: redis://redis:6379
    command: npx prisma migrate deploy

  scraper:
    build: .
    container_name: dropship_scraper
    restart: unless-stopped
    depends_on:
      migrate:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      redis:
        condition: service_started
    env_file:
      - secrets.env
    environment:
      # Override local values from secrets.env when running in Docker.
      DATABASE_URL: postgresql://admin:${POSTGRES_PASSWORD:-change_me}@postgres:5432/${POSTGRES_DB:-dropship_bot}?schema=public
      REDIS_URL: redis://redis:6379
    command: npm run scraper
    volumes:
      - ./logs:/app/logs

  brain:
    build: .
    container_name: dropship_brain
    restart: unless-stopped
    depends_on:
      migrate:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      redis:
        condition: service_started
    env_file:
      - secrets.env
    environment:
      # Override local values from secrets.env when running in Docker.
      DATABASE_URL: postgresql://admin:${POSTGRES_PASSWORD:-change_me}@postgres:5432/${POSTGRES_DB:-dropship_bot}?schema=public
      REDIS_URL: redis://redis:6379
    command: npm run brain
    volumes:
      - ./logs:/app/logs
      - ./out:/app/out
      - ./public/audio:/app/public/audio
      # Allow prompt edits without rebuilding the image (useful for tuning).
      - ./PROMPTS.md:/app/PROMPTS.md:ro

  adminer:
    image: adminer
    container_name: dropship_adminer
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - postgres

volumes:
  postgres_data:
  redis_data:

